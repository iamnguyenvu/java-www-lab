<div th:fragment="chatbot" xmlns:th="http://www.thymeleaf.org">
    <button id="chatbot-button" class="chatbot-button" type="button" aria-label="Mở trợ lý AI">
        <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 24 24" fill="none"
             stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
        </svg>
    </button>

    <div id="chatbot-window" class="chatbot-window">
        <div class="chatbot-header">
            <div>
                <h3 style="margin:0;">Trợ lý DearU</h3>
                <p style="margin:0; font-size:13px; opacity:0.85;">Sẵn sàng hỗ trợ bạn 24/7</p>
            </div>
            <button id="chatbot-close" class="chatbot-close" type="button" aria-label="Đóng trợ lý">
                ×
            </button>
        </div>

        <div class="chatbot-messages" id="chatbot-messages">
            <div class="chatbot-message">
                <div class="chatbot-bubble">
                    Xin chào! Tôi là trợ lý mua sắm dựa trên dữ liệu thật. Hỏi tôi về sản phẩm, tồn kho hoặc quy trình đặt hàng nhé.
                </div>
            </div>
        </div>

        <div class="chatbot-input-row">
            <input type="text" id="chatbot-input" class="chatbot-input" placeholder="Nhập điều bạn muốn hỏi...">
            <button id="chatbot-send" class="chatbot-send" type="button">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                     stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="22" y1="2" x2="11" y2="13"></line>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
            </button>
        </div>
    </div>

    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function() {
            const chatbotButton = document.getElementById('chatbot-button');
            const chatbotWindow = document.getElementById('chatbot-window');
            const chatbotClose = document.getElementById('chatbot-close');
            const chatbotInput = document.getElementById('chatbot-input');
            const chatbotSend = document.getElementById('chatbot-send');
            const chatbotMessages = document.getElementById('chatbot-messages');
            let sessionId = 'session-' + Date.now();

            chatbotButton.addEventListener('click', function() {
                chatbotWindow.classList.add('active');
                chatbotButton.style.display = 'none';
                chatbotInput.focus();
            });

            chatbotClose.addEventListener('click', function() {
                chatbotWindow.classList.remove('active');
                chatbotButton.style.display = 'flex';
            });

            async function sendMessage() {
                const message = chatbotInput.value.trim();
                if (!message) return;

                addMessage(message, true);
                chatbotInput.value = '';
                chatbotSend.disabled = true;

                const typingIndicator = document.createElement('div');
                typingIndicator.className = 'chatbot-message';
                typingIndicator.innerHTML = '<div class=\"chatbot-bubble\"><div class=\"typing-indicator\"><span></span><span></span><span></span></div></div>';
                chatbotMessages.appendChild(typingIndicator);
                chatbotMessages.scrollTop = chatbotMessages.scrollHeight;

                try {
                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ message, sessionId })
                    });

                    const data = await response.json();
                    typingIndicator.remove();

                    if (data.error) {
                        addMessage('Xin lỗi, đã có lỗi xảy ra: ' + data.error, false);
                    } else {
                        addMessage(data.message, false);
                    }
                } catch (error) {
                    typingIndicator.remove();
                    addMessage('Xin lỗi, không thể kết nối đến máy chủ. Vui lòng thử lại sau.', false);
                } finally {
                    chatbotSend.disabled = false;
                }
            }

            function addMessage(text, isUser) {
                const wrapper = document.createElement('div');
                wrapper.className = 'chatbot-message' + (isUser ? ' chatbot-message--user' : '');
                wrapper.innerHTML = `<div class=\"chatbot-bubble\">${escapeHtml(text)}</div>`;
                chatbotMessages.appendChild(wrapper);
                chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
            }

            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML.replace(/\\n/g, '<br>');
            }

            chatbotSend.addEventListener('click', sendMessage);
            chatbotInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
        });
    </script>
</div>
