<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title th:text="${product != null ? product.name : 'S·∫£n ph·∫©m'}">S·∫£n ph·∫©m</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>

<div th:replace="~{fragments/navbar :: navbar}"></div>

<div class="page-container">

    <div th:if="${product != null}">
        <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
        <div th:if="${error}" class="alert alert-error" th:text="${error}"></div>

        <div class="page-header">
            <div>
                <p class="page-subtitle" style="margin:0;">M√£ s·∫£n ph·∫©m #<span th:text="${product.productId}"></span></p>
                <h1 class="page-title" th:text="${product.name}"></h1>
                <p class="page-subtitle" th:text="${product.description ?: 'S·∫£n ph·∫©m ƒëang c·∫≠p nh·∫≠t m√¥ t·∫£'}"></p>
            </div>
            <div class="page-actions">
                <a th:href="@{/products}" class="btn btn-ghost">‚Üê Danh s√°ch s·∫£n ph·∫©m</a>
                <div sec:authorize="hasRole('ADMIN')" style="display:flex; gap:var(--space-2);">
                    <a th:href="@{/products/edit/{id}(id=${product.productId})}" class="btn btn-outline">Ch·ªânh s·ª≠a</a>
                    <form th:action="@{/products/delete}" method="post" style="margin:0;" onsubmit="return confirm('X√≥a s·∫£n ph·∫©m n√†y?');">
                        <input type="hidden" name="id" th:value="${product.productId}">
                        <button class="btn btn-danger">X√≥a</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="product-detail-grid">
            <div class="product-gallery">
                <div class="product-gallery__media">
                    <img th:if="${product.imageUrl}" th:src="@{${product.imageUrl}}" th:alt="${product.name}">
                    <div th:unless="${product.imageUrl}" style="font-size:64px;">üõçÔ∏è</div>
                </div>
                <div class="tag-row" style="margin-top:var(--space-4);">
                    <span th:class="${product.inStock ? 'badge badge-success' : 'badge badge-danger'}"
                          th:text="${product.inStock ? 'C√≤n h√†ng' : 'H·∫øt h√†ng'}"></span>
                    <span class="badge badge-info" th:text="${'T·ªìn kho: ' + (product.stock != null ? product.stock : 0)}"></span>
                    <span class="badge badge-warning" th:if="${product.categoryName}" th:text="${product.categoryName}"></span>
                </div>
            </div>

            <div class="product-meta">
                <section class="page-section" style="margin:0;">
                    <p class="price-display" th:text="${#numbers.formatDecimal(product.price, 0, 'COMMA', 0, 'POINT')} + ' ‚Ç´'"></p>
                    <p class="page-subtitle" style="margin-bottom:var(--space-5);">
                        Gi√° ƒë√£ bao g·ªìm VAT. Ki·ªÉm tra t·ªìn kho tr∆∞·ªõc khi th√™m v√†o gi·ªè.
                    </p>

                    <ul class="detail-list">
                        <li class="detail-item">
                            <span class="detail-item__label">Danh m·ª•c</span>
                            <span class="detail-item__value" th:text="${product.categoryName ?: 'Ch∆∞a ph√¢n lo·∫°i'}"></span>
                        </li>
                        <li class="detail-item">
                            <span class="detail-item__label">S·ªë l∆∞·ª£ng t·ªìn</span>
                            <span class="detail-item__value"
                                  th:text="${(product.stock != null ? product.stock : 0)} + ' s·∫£n ph·∫©m'"></span>
                        </li>
                        <li class="detail-item" th:if="${product.averageRating != null}">
                            <span class="detail-item__label">ƒê√°nh gi√°</span>
                            <span class="detail-item__value">
                                <strong th:text="${#numbers.formatDecimal(product.averageRating, 1, 'POINT', 1, 'POINT')} + '/5'"></strong>
                                <span class="badge badge-info" th:text="'(' + ${product.commentCount} + ' ƒë√°nh gi√°)'"></span>
                            </span>
                        </li>
                    </ul>
                </section>

                <section class="page-section" style="margin:0;">
                    <h3 style="margin-top:0;">Thao t√°c</h3>
                    <div style="display:flex; flex-wrap:wrap; gap:var(--space-3); align-items:center;">
                        <form th:if="${product.inStock}"
                              th:action="@{/cart/add/{id}(id=${product.productId})}"
                              method="post"
                              style="display:flex; gap:var(--space-3); align-items:center;">
                            <label for="quantity" style="font-weight:600;">S·ªë l∆∞·ª£ng:</label>
                            <input type="number"
                                   id="quantity"
                                   name="quantity"
                                   value="1"
                                   min="1"
                                   th:max="${product.stock}"
                                   class="form-control"
                                   style="max-width:120px;">
                            <button type="submit" class="btn btn-primary">üõí Th√™m v√†o gi·ªè</button>
                        </form>

                        <div th:if="${!product.inStock}" class="badge badge-danger">S·∫£n ph·∫©m ƒë√£ h·∫øt h√†ng</div>

                        <p class="page-subtitle" style="margin:0;" sec:authorize="isAnonymous()">
                            B·∫°n c√≥ th·ªÉ th√™m v√†o gi·ªè m√† kh√¥ng c·∫ßn ƒëƒÉng nh·∫≠p. ƒêƒÉng nh·∫≠p s·∫Ω c·∫ßn khi thanh to√°n.
                        </p>
                    </div>
                </section>
            </div>
        </div>

        <section class="page-section" th:if="${product.comments != null && !#lists.isEmpty(product.comments)}" style="margin-top:var(--space-6);">
            <h3 style="margin-top:0;">ƒê√°nh gi√° t·ª´ kh√°ch h√†ng</h3>
            <div th:each="c : ${product.comments}" style="padding:var(--space-4) 0; border-bottom:1px solid var(--border-light);">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <strong th:text="${c.customerName ?: 'Kh√°ch h√†ng'}"></strong>
                    <span th:if="${c.rating}" th:text="${c.rating} + '/5 ‚≠ê'"></span>
                </div>
                <p th:text="${c.text}" style="margin:var(--space-2) 0;"></p>
                <small class="text-muted" th:text="${#dates.format(c.commentDate, 'dd/MM/yyyy HH:mm')}"></small>
            </div>
        </section>
    </div>

    <div th:if="${product == null}" class="empty-state">
        <div style="font-size:60px; margin-bottom:var(--space-4);">üôà</div>
        <h3>Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m</h3>
        <p>C√≥ th·ªÉ s·∫£n ph·∫©m ƒë√£ b·ªã x√≥a ho·∫∑c kh√¥ng t·ªìn t·∫°i.</p>
        <a th:href="@{/products}" class="btn btn-ghost" style="margin-top:var(--space-4);">‚Üê Quay l·∫°i danh s√°ch</a>
    </div>

</div>

<!-- Include Chatbot -->
<div th:replace="~{fragments/chatbot :: chatbot}"></div>

</body>
</html>
