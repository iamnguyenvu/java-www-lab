<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title th:text="${product != null ? product.name : 'San pham'}"></title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>

<div th:replace="~{fragments/navbar :: navbar}"></div>

<div class="page-container">

<div th:if="${product != null}">
    <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
    <div th:if="${error}" class="alert alert-error" th:text="${error}"></div>
    
    <h2 class="page-header" th:text="${product.name}"></h2>
    
    <div class="product-detail-container">
        <div class="product-image">
            <img th:if="${product.imageUrl}" th:src="@{${product.imageUrl}}" 
                 th:alt="${product.name}" style="max-width: 400px; border-radius: 8px;">
            <img th:unless="${product.imageUrl}" th:src="@{/images/no-image.png}" 
                 alt="No image" style="max-width: 400px; border-radius: 8px;">
        </div>
        
        <div class="product-info">
            <div class="card" style="margin-bottom: 20px;">
                <table>
                    <tr>
                        <td style="width: 150px;"><b>M√£ s·∫£n ph·∫©m:</b></td>
                        <td th:text="${product.productId}"></td>
                    </tr>
                    <tr th:if="${product.categoryName}">
                        <td><b>Danh m·ª•c:</b></td>
                        <td th:text="${product.categoryName}"></td>
                    </tr>
                    <tr th:if="${product.description}">
                        <td><b>M√¥ t·∫£:</b></td>
                        <td th:text="${product.description}"></td>
                    </tr>
                    <tr>
                        <td><b>Gi√°:</b></td>
                        <td style="color: #e74c3c; font-weight: bold; font-size: 24px;" 
                            th:text="${#numbers.formatDecimal(product.price, 0, 'COMMA', 0, 'POINT')} + ' VNƒê'"></td>
                    </tr>
                    <tr>
                        <td><b>T·ªìn kho:</b></td>
                        <td th:text="${product.stock} + ' s·∫£n ph·∫©m'"></td>
                    </tr>
                    <tr>
                        <td><b>Tr·∫°ng th√°i:</b></td>
                        <td>
                            <span th:class="${product.inStock ? 'badge badge-success' : 'badge badge-danger'}" 
                                  th:text="${product.inStock ? 'C√≤n h√†ng' : 'H·∫øt h√†ng'}"></span>
                        </td>
                    </tr>
                    <tr th:if="${product.averageRating != null}">
                        <td><b>ƒê√°nh gi√°:</b></td>
                        <td>
                            <span th:text="${#numbers.formatDecimal(product.averageRating, 1, 'POINT', 1, 'POINT')} + '/5'"></span>
                            <span class="badge badge-info" th:text="'(' + ${product.commentCount} + ' ƒë√°nh gi√°)'"></span>
                        </td>
                    </tr>
                </table>
            </div>

            <div style="margin: 20px 0; display:flex; flex-wrap:wrap; gap:12px; align-items:center;">
                <form th:if="${product.inStock}" th:action="@{/cart/add/{id}(id=${product.productId})}" method="post" style="display:flex; align-items:center; gap:10px;">
                    <label for="quantity" style="font-weight:600;">S·ªë l∆∞·ª£ng:</label>
                    <input type="number" id="quantity" name="quantity" value="1" min="1"
                           th:max="${product.stock}"
                           style="width: 80px; margin-right: 5px;">
                    <button type="submit" class="btn btn-primary">üõí Th√™m v√†o gi·ªè</button>
                </form>
                
                <div th:if="${!product.inStock}" class="badge badge-danger">S·∫£n ph·∫©m ƒë√£ h·∫øt h√†ng</div>
                
                <p class="page-subtitle" style="margin:0;" sec:authorize="isAnonymous()">
                    B·∫°n c√≥ th·ªÉ th√™m v√†o gi·ªè m√† kh√¥ng c·∫ßn ƒëƒÉng nh·∫≠p. T√†i kho·∫£n ch·ªâ b·∫Øt bu·ªôc khi thanh to√°n.
                </p>
                
                <div sec:authorize="hasRole('ADMIN')" style="display:flex; gap:8px;">
                    <a th:href="@{/products/edit/{id}(id=${product.productId})}" class="btn btn-ghost">S·ª≠a</a>
                    <form th:action="@{/products/delete}" method="post" style="display:inline">
                        <input type="hidden" name="id" th:value="${product.productId}">
                        <button class="btn btn-danger" onclick="return confirm('X√≥a s·∫£n ph·∫©m n√†y?')">X√≥a</button>
                    </form>
                </div>
                
                <a th:href="@{/products}" class="btn btn-secondary">‚Üê Quay l·∫°i</a>
            </div>
        </div>
    </div>

    <!-- Comments section -->
    <div th:if="${product.comments != null && !#lists.isEmpty(product.comments)}" class="card" style="margin: 20px 0;">
        <h3>ƒê√°nh gi√° t·ª´ kh√°ch h√†ng</h3>
        <div th:each="c : ${product.comments}" style="border-bottom: 1px solid #eee; padding: 15px 0;">
            <div style="display: flex; justify-content: space-between;">
                <strong th:text="${c.customerName ?: 'Kh√°ch h√†ng'}"></strong>
                <span th:if="${c.rating}" th:text="${c.rating} + '/5‚≠ê'"></span>
            </div>
            <p th:text="${c.text}" style="margin: 10px 0;"></p>
            <small style="color: #7f8c8d;" th:text="${#dates.format(c.commentDate, 'dd/MM/yyyy HH:mm')}"></small>
        </div>
    </div>
</div>

<div th:if="${product == null}" class="empty-state">
    <p>Khong tim thay san pham.</p>
    <a th:href="@{/products}" class="btn btn-secondary">Quay lai</a>
</div>

</div>

<!-- Include Chatbot -->
<div th:replace="~{fragments/chatbot :: chatbot}"></div>

</body>
</html>
